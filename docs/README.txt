# 录音延迟测试

## 录音延迟的测试方法概述

使用oboe进行播放音频的同时进行录音，录音会把播放的音频再次录入进来。然后，把原始音频作为左声道、录音数据作为右声道，合成为新的音频保存到本地文件中。最后通过Audacity等工具来查看合成的音频文件，评估左右声道之间的误差。

## 实现步骤

**java层页面需要实现的功能：**

1. 通过jni调用native库中的延迟测试功能，原始音频（可以先代码中写死一个路径）以及输出文件（录音后合成的音频）的路径。
2. java层功能目前不需要太复杂，主要用处传入各种信息，主要功能在native层实现。

**native层需要实现的功能：**

1.首先通过ffmpeg将原始音频解码为48000Hz、双声道、short类型的pcm数据并保存到cache目录中（路径从java层传入）；
2.通过oboe启动输出流和输入流；
3.输出流用来播放原始音频的pcm，同时把音频写入到一个循环buffer中；
4.输入流用来录音，录音设置为48000Hz、双声道、short类型，开启低延迟、独占模式等，把录音数据写入另一个循环buffer中；
5.另一个线程循环读取这两个buffer，把原始音频作为左声道、录音数据作为右声道合成新的音频，并保存到本地；
6.原始频频播放完成后（或者用户主动停止），把合成的音频通过ffmpeg编码为m4a音频文件；

其他要求：循环buffer需要选择合适的大小，优先测试出来的延时数据是可靠的。

## 录音自动增益功能

有时候录音的音量很小，导致无法进行对比。在编码为m4a文件之前，重新统计右声道的平均音量、最大音量。
如果右声道音量比左声道低很多，则以左声道的原始音频为基准，将右声道的数据进行放大处理（注意左声道保持不变），使左右声道的音量保持基本一致。

## 代码依赖

ffmpeg头文件目录：app/include
ffmpeg库目录：app/libs
oboe源码路径：app/src/main/cpp/oboe-1.7.0
